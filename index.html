<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Track your crypto, stocks, and gold portfolio with real-time prices">
  <title>Portfolio Tracker | Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="images/icon-192.png">
  <link rel="apple-touch-icon" href="images/icon-192.png">
  <meta name="theme-color" content="#0f172a">
  <style>
    .profit {
      color: #00d4aa;
    }

    .loss {
      color: #ff5050;
    }

    .profit-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .profit-badge.positive {
      background: rgba(0, 212, 170, 0.15);
      color: #00d4aa;
    }

    .profit-badge.negative {
      background: rgba(255, 80, 80, 0.15);
      color: #ff5050;
    }

    .asset-icon-img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }

    .total-profit {
      text-align: center;
      margin-top: var(--spacing-sm);
      padding-top: var(--spacing-sm);
      border-top: 1px solid var(--border-color);
    }

    .total-profit-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .total-profit-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* Mobile-optimized asset item */
    .asset-item {
      flex-wrap: wrap;
    }

    .asset-value {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      min-width: 0;
    }

    .asset-pnl {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    /* Mobile responsive */
    @media (max-width: 480px) {
      .asset-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .asset-value {
        width: 100%;
        align-items: flex-start;
        padding-left: 48px;
      }

      .asset-pnl {
        justify-content: flex-start;
      }

      .stat-card {
        padding: var(--spacing-sm);
      }

      .stat-value {
        font-size: 1.2rem;
      }

      .chart-wrapper {
        width: 260px;
        height: 260px;
      }

      .chart-total-value {
        font-size: 1.4rem;
      }
    }

    /* Mobile Mode Toggle */
    .mobile-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
    }

    .mobile-toggle input {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: var(--accent-crypto);
    }

    .mobile-toggle:hover {
      color: var(--text-primary);
    }

    /* Mobile Mode Layout - only applies when checkbox is checked */
    body.mobile-mode main {
      display: flex;
      flex-direction: column;
    }

    body.mobile-mode .dashboard-grid {
      display: contents;
      /* Unwrap the grid so children can be reordered */
    }

    body.mobile-mode #chartSection {
      order: 1;
    }

    body.mobile-mode #statsGrid {
      order: 2;
    }

    body.mobile-mode #assetsSection {
      order: 3;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <img src="images/icon-192.png" alt="Logo" style="width: 32px; height: 32px; border-radius: 6px;">
        Portfolio Tracker
      </div>
      <nav style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <!-- Currency Selector -->
        <select id="currencySelect" class="currency-select" title="Select currency">
          <option value="USD">üá∫üá∏ USD</option>
          <option value="VND">üáªüá≥ VND</option>
        </select>
        <!-- Theme Toggle -->
        <button id="themeToggle" class="theme-toggle" title="Toggle theme">
          <span id="themeIcon">üåô</span>
        </button>
        <!-- Mobile Mode Toggle -->
        <label class="mobile-toggle" title="Reorder layout for mobile">
          <input type="checkbox" id="mobileMode">
          üì±
        </label>
        <a href="rebalance.html" class="nav-link">‚öñÔ∏è Rebalance</a>
        <a href="admin.html" class="nav-link">‚öôÔ∏è Manage</a>
      </nav>
    </header>

    <!-- Main Dashboard -->
    <main>
      <!-- Mobile Hero Section (Hidden on Desktop) -->
      <div class="hero-section" id="heroSection" style="position: relative; overflow: hidden;">
        <div id="heroChartContainer"
          style="position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; z-index: 0; opacity: 0.6; pointer-events: none;">
          <canvas id="heroChart"></canvas>
        </div>
        <div style="position: relative; z-index: 1;">
          <div class="hero-label">Total Portfolio Value</div>
          <div class="hero-value" id="heroTotalValue">$0</div>

          <div class="pnl-cards">
            <div class="pnl-card" id="heroPnlCard">
              <div class="pnl-amount" id="heroPnlAmount">$0</div>
              <div class="pnl-percent" id="heroPnlPercent">0%</div>
            </div>
            <!-- You could add a second card for 24h vs All time if data exists, 
               but for now we stick to one or split PnL $ and % as per guide -->
          </div>
        </div>
      </div>

      <!-- Mobile Tab Navigation (Hidden on Desktop) -->
      <div class="tab-nav" id="tabNav">
        <button class="tab-btn active" data-tab="assetsSection">Assets</button>
        <button class="tab-btn" data-tab="chartSection">Distribution</button>
      </div>

      <!-- Stats Overview (Desktop Only) -->
      <div class="stats-grid fade-in" id="statsGrid">
        <div class="stat-card crypto">
          <div class="stat-label">Crypto</div>
          <div class="stat-value" id="cryptoValue">$0</div>
          <div class="stat-percent" id="cryptoPercent">0%</div>
          <div class="stat-profit" id="cryptoProfit"></div>
        </div>
        <div class="stat-card stocks">
          <div class="stat-label">USA Stocks</div>
          <div class="stat-value" id="stocksValue">$0</div>
          <div class="stat-percent" id="stocksPercent">0%</div>
          <div class="stat-profit" id="stocksProfit"></div>
        </div>
        <div class="stat-card gold">
          <div class="stat-label">Gold</div>
          <div class="stat-value" id="goldValue">$0</div>
          <div class="stat-percent" id="goldPercent">0%</div>
          <div class="stat-profit" id="goldProfit"></div>
        </div>
      </div>

      <!-- Chart and Assets Grid -->
      <div class="dashboard-grid">
        <!-- Assets List Card -->
        <div class="card fade-in" id="assetsSection">
          <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
            Your Assets
            <span id="portfolioPlainValue"
              style="font-size: 1rem; color: var(--text-secondary); font-weight: 500;">$0</span>
          </div>

          <!-- Assets Header Row (Mobile) -->
          <div class="assets-header"
            style="display: none; padding: 8px 16px; border-bottom: 1px solid var(--border-color); font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase;">
            <div style="flex: 1.5; display: flex; align-items: center; gap: 4px;">
              <span>‚ñº</span> Qty. Total
            </div>
            <div style="flex: 1.2; text-align: right; padding-right: 12px;">Unrealized</div>
            <div style="flex: 0.8; text-align: right;">Price</div>
          </div>

          <div class="legend">
            <div class="legend-item" data-category="crypto">
              <span class="legend-color crypto"></span>
              <span class="legend-label">Crypto</span>
            </div>
            <div class="legend-item" data-category="stocks">
              <span class="legend-color stocks"></span>
              <span class="legend-label">Stocks</span>
            </div>
            <div class="legend-item" data-category="gold">
              <span class="legend-color gold"></span>
              <span class="legend-label">Gold</span>
            </div>
          </div>
          <!-- Total Profit/Loss -->
          <div class="total-profit" id="totalProfitContainer" style="display: none;">
            <div class="total-profit-label">Total P/L</div>
            <div class="total-profit-value" id="totalProfitValue">$0</div>
          </div>

          <div class="assets-list" id="assetsList">
          </div>

          <!-- History Chart Section -->
          <div class="history-section" id="historySection">
            <div class="history-header" onclick="toggleHistoryChart()"
              style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-top: 1px solid var(--border-color); margin-top: 15px;">
              <span style="font-size: 0.9rem; color: var(--text-secondary);">üìà Performance History</span>
              <span id="historyToggle" style="color: var(--text-muted);">‚ñº</span>
            </div>
            <div id="historyContent" style="display: block;">
              <div class="period-selector" style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button class="period-btn active" data-days="7" onclick="updateHistoryChart(7)">7D</button>
                <button class="period-btn" data-days="30" onclick="updateHistoryChart(30)">30D</button>
                <button class="period-btn" data-days="90" onclick="updateHistoryChart(90)">90D</button>
                <button class="period-btn" data-days="0" onclick="updateHistoryChart(0)">All</button>
              </div>
              <div class="history-chart" style="height: 150px; position: relative;">
                <canvas id="historyChart"></canvas>
                <div id="historyEmpty"
                  style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.85rem;">
                  Not enough data yet. Check back later!
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart Section -->
        <div class="card fade-in" id="chartSection">
          <div class="card-title">Portfolio Allocation</div>
          <div class="chart-container">
            <div class="chart-wrapper">
              <canvas id="portfolioChart"></canvas>
              <div class="chart-center">
                <div class="chart-total-label">Total Balance</div>
                <div class="chart-total-value" id="totalValue">$0.00</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Tooltip -->
  <div class="chart-tooltip" id="chartTooltip"></div>

  <!-- Scripts -->
  <script src="js/app.js"></script>
  <script src="js/dom-utils.js"></script>
  <script src="js/chart.js"></script>
  <script>
    // Dashboard Logic
    let chart;
    let isRefreshing = false;

    async function initDashboard() {
      // Initialize chart
      chart = new PortfolioChart('portfolioChart', 'chartTooltip');

      // Add legend click listeners
      document.querySelectorAll('.legend-item').forEach(item => {
        item.addEventListener('click', () => {
          const category = item.dataset.category;
          chart.showTooltipForCategory(category);
        });
      });

      // Load and display data
      await refreshData();
    }

    async function refreshData() {
      if (isRefreshing) return;

      const refreshBtn = document.getElementById('refreshBtn');
      isRefreshing = true;
      refreshBtn.classList.add('spinning');

      try {
        const data = await PortfolioApp.calculatePortfolio();
        updateUI(data);
        chart.update(data);
      } catch (error) {
        console.error('Error refreshing data:', error);
      } finally {
        isRefreshing = false;
        refreshBtn.classList.remove('spinning');
      }
    }

    function updateUI(data) {
      // Update total value - use compact format for large numbers
      const formattedTotal = PortfolioApp.formatCurrencyCompact(data.grandTotal);
      document.getElementById('totalValue').textContent = formattedTotal;

      // Update Hero Section (Mobile)
      document.getElementById('heroTotalValue').textContent = PortfolioApp.formatCurrency(data.grandTotal);

      // Update plain value next to "Your Assets" - full number format
      document.getElementById('portfolioPlainValue').textContent =
        new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(data.grandTotal);

      // Update category stats
      const categories = ['crypto', 'stocks', 'gold'];
      categories.forEach(cat => {
        const catData = data.categories[cat];
        document.getElementById(`${cat}Value`).textContent =
          PortfolioApp.formatCurrency(catData.total);
        document.getElementById(`${cat}Percent`).textContent =
          PortfolioApp.formatPercent(catData.percentage);

        // Show profit/loss per category
        const profitEl = document.getElementById(`${cat}Profit`);
        if (catData.costBasis > 0) {
          const isPositive = catData.profitLoss >= 0;
          const sign = isPositive ? '+' : '';
          profitEl.innerHTML = `
            <span class="profit-badge ${isPositive ? 'positive' : 'negative'}">
              ${sign}${PortfolioApp.formatPercent(catData.profitLossPercent)}
            </span>
          `;
        } else {
          profitEl.innerHTML = '';
        }
      });

      // Update total profit/loss (Desktop & Mobile Hero)
      const profitContainer = document.getElementById('totalProfitContainer');
      const profitValue = document.getElementById('totalProfitValue');

      // Hero PnL elements
      const heroPnlCard = document.getElementById('heroPnlCard');
      const heroPnlAmount = document.getElementById('heroPnlAmount');
      const heroPnlPercent = document.getElementById('heroPnlPercent');

      if (data.totalCostBasis > 0) {
        // Desktop
        profitContainer.style.display = 'block';
        const isPositive = data.totalProfitLoss >= 0;
        const sign = isPositive ? '+' : '';
        profitValue.className = `total-profit-value ${isPositive ? 'profit' : 'loss'}`;
        profitValue.textContent = `${sign}${PortfolioApp.formatCurrency(data.totalProfitLoss)} (${sign}${PortfolioApp.formatPercent(data.totalProfitLossPercent)})`;

        // Mobile Hero
        heroPnlCard.style.display = 'flex'; // or block
        heroPnlCard.className = `pnl-card ${isPositive ? 'positive' : 'negative'}`;
        heroPnlAmount.textContent = `${sign}${PortfolioApp.formatCurrency(data.totalProfitLoss)}`;
        heroPnlPercent.textContent = `${sign}${PortfolioApp.formatPercent(data.totalProfitLossPercent)}`;
      } else {
        // Desktop
        profitContainer.style.display = 'none';
        // Mobile
        heroPnlCard.style.display = 'none';
      }

      // Update assets list - Sort by Value Descending Globally
      const sortedAssets = [...data.assets].sort((a, b) => b.value - a.value);
      updateAssetsList(sortedAssets);
    }

    function updateAssetsList(assets) {
      const container = document.getElementById('assetsList');

      if (assets.length === 0) {
        DOMUtils.showEmptyState(container, 'No assets yet', {
          text: 'Add your first asset',
          href: 'admin.html'
        });
        return;
      }

      // Clear and render using safe DOM utils
      container.innerHTML = '';
      assets.forEach(asset => {
        const item = DOMUtils.createAssetItem(asset, {
          showValue: true,
          showPnL: true
        });
        container.appendChild(item);
      });
    }

    function getCategoryLabel(category) {
      const labels = {
        crypto: 'Crypto',
        stocks: 'Stocks',
        gold: 'Gold'
      };
      return labels[category] || category;
    }

    // Mobile Mode Toggle
    function initMobileMode() {
      const checkbox = document.getElementById('mobileMode');
      const saved = localStorage.getItem('portfolioMobileMode');

      const applyMobileMode = (isMobile) => {
        if (isMobile) {
          document.body.classList.add('mobile-mode');
          // Start with Assets tab Active when switching to mobile
          switchTab('assetsSection');
        } else {
          document.body.classList.remove('mobile-mode');
          // Reset visibility of cards for desktop
          document.getElementById('chartSection').style.display = '';
          document.getElementById('assetsSection').style.display = '';
        }
      };

      if (saved === 'true') {
        checkbox.checked = true;
        applyMobileMode(true);
      }

      checkbox.addEventListener('change', function () {
        applyMobileMode(this.checked);
        localStorage.setItem('portfolioMobileMode', this.checked);
      });
    }

    // Tab System
    function switchTab(tabId) {
      // Only relevant in mobile mode
      if (!document.body.classList.contains('mobile-mode')) return;

      // Update buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabId);
      });

      // Update Content
      // Hide all main sections first
      document.getElementById('chartSection').classList.remove('active-tab');
      document.getElementById('assetsSection').classList.remove('active-tab');

      // Show target
      const target = document.getElementById(tabId);
      if (target) {
        target.classList.add('active-tab');
      }
    }

    function initTabSystem() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          switchTab(btn.dataset.tab);
        });
      });
    }

    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', refreshData);

    // Theme Toggle
    document.getElementById('themeToggle').addEventListener('click', () => {
      const newTheme = ThemeManager.toggle();
      document.getElementById('themeIcon').textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      ToastManager.success(`Switched to ${newTheme} theme`);
    });

    // Currency Selector
    document.getElementById('currencySelect').addEventListener('change', async (e) => {
      await CurrencyManager.setCurrency(e.target.value);
      ToastManager.info(`Currency changed to ${e.target.value}`);
      refreshData();
    });

    // History Chart Functions
    function toggleHistoryChart() {
      const content = document.getElementById('historyContent');
      const toggle = document.getElementById('historyToggle');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '‚ñº';
      } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñ∂';
      }
    }

    function updateHistoryChart(days) {
      // Update active button (both desktop and mobile)
      document.querySelectorAll('.period-btn').forEach(btn => {
        // Simple logic for All vs Int
        const btnDays = parseInt(btn.onclick.toString().match(/\d+/)[0]);
        btn.classList.toggle('active', btnDays === days); // Approximate match needed or improve btn selection
      });
      // Better: pass references or selection logic but for now simple toggle.
      // Re-query based on onclick attribute or data attribute is slightly fragile but quick.
      // Let's implement robust selection:
      document.querySelectorAll('.period-btn').forEach(btn => {
        // Reset
        btn.classList.remove('active');
        if (btn.getAttribute('onclick').includes(`(${days})`)) {
          btn.classList.add('active');
        }
      });

      // Get history data
      const history = HistoryTracker.getAll();
      const filtered = days === 0 ? history : history.slice(-days);

      if (filtered.length < 2) {
        document.getElementById('historyEmpty').style.display = 'flex';
        return;
      }

      document.getElementById('historyEmpty').style.display = 'none';

      // Draw Desktop Chart
      drawLineChart(filtered, 'historyChart');
      // Draw Mobile Hero Chart
      drawLineChart(filtered, 'heroChart', true);
    }

    function drawLineChart(data, canvasId, isHero = false) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return; // Canvas might not exist or be hidden

      const ctx = canvas.getContext('2d');
      const rect = canvas.parentElement.getBoundingClientRect();

      // Adjust size
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      const width = rect.width;
      const height = rect.height;

      // Hero chart has less padding
      const padding = isHero ? { top: 5, right: 0, bottom: 5, left: 0 } : { top: 10, right: 10, bottom: 20, left: 50 };

      const values = data.map(d => d.total);
      const minVal = Math.min(...values) * 0.99;
      const maxVal = Math.max(...values) * 1.01;

      ctx.clearRect(0, 0, width, height);

      // Draw line
      ctx.beginPath();
      ctx.strokeStyle = '#f7931a'; // Orange
      ctx.lineWidth = isHero ? 3 : 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      data.forEach((d, i) => {
        const x = padding.left + (i / (data.length - 1)) * (width - padding.left - padding.right);
        const y = padding.top + (1 - (d.total - minVal) / (maxVal - minVal)) * (height - padding.top - padding.bottom);

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });

      ctx.stroke();

      // Add gradient fill for Hero
      if (isHero) {
        ctx.lineTo(width, height);
        ctx.lineTo(0, height);
        ctx.closePath();
        const gradient = ctx.createLinearGradient(0, 0, 0, height);
        gradient.addColorStop(0, 'rgba(247, 147, 26, 0.2)');
        gradient.addColorStop(1, 'rgba(247, 147, 26, 0)');
        ctx.fillStyle = gradient;
        ctx.fill();
      }
    }

    // Offline Detection
    window.addEventListener('online', () => ToastManager.success('Back online!'));
    window.addEventListener('offline', () => ToastManager.warning('You are offline'));

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize managers
      ThemeManager.init();
      CurrencyManager.init();

      // Update theme icon
      document.getElementById('themeIcon').textContent = ThemeManager.get() === 'dark' ? 'üåô' : '‚òÄÔ∏è';

      // Set currency selector
      document.getElementById('currencySelect').value = CurrencyManager.current;

      initMobileMode();
      initTabSystem();
      initDashboard();

      // Initialize history chart
      updateHistoryChart(7);

      // Register Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed', err));
      }
    });
  </script>
</body>

</html>