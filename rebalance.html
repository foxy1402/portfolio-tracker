<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Portfolio Rebalance Calculator - Calculate what to buy or sell">
    <title>Portfolio Tracker | Rebalance Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .rebalance-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .current-allocation {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        @media (max-width: 600px) {
            .current-allocation {
                grid-template-columns: 1fr;
            }
        }

        .allocation-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
        }

        .allocation-card.crypto {
            border-color: var(--accent-crypto);
        }

        .allocation-card.stocks {
            border-color: var(--accent-stocks);
        }

        .allocation-card.gold {
            border-color: var(--accent-gold);
        }

        .allocation-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .allocation-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .allocation-value.crypto {
            color: var(--accent-crypto);
        }

        .allocation-value.stocks {
            color: var(--accent-stocks);
        }

        .allocation-value.gold {
            color: var(--accent-gold);
        }

        .allocation-percent {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .target-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        @media (max-width: 600px) {
            .target-inputs {
                grid-template-columns: 1fr;
            }
        }

        .target-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .target-input-label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .target-input-label .emoji {
            font-size: 1.2rem;
        }

        .target-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 12px;
            font-size: 1.1rem;
            color: var(--text-primary);
            text-align: center;
            width: 100%;
        }

        .target-input:focus {
            outline: none;
            border-color: var(--accent-crypto);
        }

        .target-total {
            text-align: center;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
            font-weight: 500;
        }

        .target-total.valid {
            background: rgba(0, 212, 170, 0.1);
            color: var(--accent-stocks);
        }

        .target-total.invalid {
            background: rgba(255, 80, 80, 0.1);
            color: #ff5050;
        }

        .results-section {
            margin-top: var(--spacing-lg);
        }

        .result-category {
            margin-bottom: var(--spacing-lg);
        }

        .result-category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-glass);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
        }

        .result-category-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-category-action {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .result-category-action.buy {
            color: var(--accent-stocks);
        }

        .result-category-action.sell {
            color: #ff5050;
        }

        .result-category-action.hold {
            color: var(--text-muted);
        }

        .asset-result {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .asset-result-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .asset-result-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .asset-result-icon.crypto {
            background: linear-gradient(135deg, var(--accent-crypto), #8b5cf6);
        }

        .asset-result-icon.stocks {
            background: linear-gradient(135deg, var(--accent-stocks), #10b981);
        }

        .asset-result-icon.gold {
            background: linear-gradient(135deg, var(--accent-gold), #f59e0b);
        }

        .asset-result-icon img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .asset-result-name {
            font-weight: 500;
        }

        .asset-result-details {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .asset-result-action {
            text-align: right;
        }

        .action-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .action-badge.buy {
            background: rgba(0, 212, 170, 0.15);
            color: var(--accent-stocks);
        }

        .action-badge.sell {
            background: rgba(255, 80, 80, 0.15);
            color: #ff5050;
        }

        .action-badge.hold {
            background: rgba(128, 128, 128, 0.15);
            color: var(--text-muted);
        }

        .action-amount {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .summary-box {
            background: linear-gradient(135deg, var(--bg-glass), var(--bg-secondary));
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .summary-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
        }

        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        .summary-item {
            padding: var(--spacing-sm);
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .summary-item-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .summary-item-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .summary-item-value.positive {
            color: var(--accent-stocks);
        }

        .summary-item-value.negative {
            color: #ff5050;
        }

        .no-assets-message {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .no-assets-message a {
            color: var(--accent-crypto);
        }

        /* Asset Selection Styles */
        .category-section {
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .category-section.crypto {
            border-color: var(--accent-crypto);
        }

        .category-section.stocks {
            border-color: var(--accent-stocks);
        }

        .category-section.gold {
            border-color: var(--accent-gold);
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--bg-glass);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .category-header:hover {
            background: var(--bg-secondary);
        }

        .category-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-header-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .category-header-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-header-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .category-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .category-target-input {
            width: 80px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
        }

        .category-target-input:focus {
            outline: none;
            border-color: var(--accent-crypto);
        }

        .expand-icon {
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .category-section.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .asset-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-section.expanded .asset-list {
            max-height: 1000px;
        }

        .asset-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .asset-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .asset-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-crypto);
        }

        .asset-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .asset-icon.crypto {
            background: linear-gradient(135deg, var(--accent-crypto), #8b5cf6);
        }

        .asset-icon.stocks {
            background: linear-gradient(135deg, var(--accent-stocks), #10b981);
        }

        .asset-icon.gold {
            background: linear-gradient(135deg, var(--accent-gold), #f59e0b);
        }

        .asset-icon img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .asset-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .asset-name {
            font-weight: 500;
        }

        .asset-value {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .asset-target-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .asset-target-input {
            width: 60px;
            padding: 6px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.9rem;
            text-align: center;
        }

        .asset-target-input:focus {
            outline: none;
            border-color: var(--accent-crypto);
        }

        .asset-target-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .asset-target-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .intra-category-total {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 0.85rem;
        }

        .intra-category-total.valid {
            color: var(--accent-stocks);
        }

        .intra-category-total.invalid {
            color: #ff5050;
        }

        .loading {
            text-align: center;
            padding: var(--spacing-lg);
            color: var(--text-secondary);
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }
    </style>
</head>

<body>
    <div class="container rebalance-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">‚öñÔ∏è</div>
                Rebalance Calculator
            </div>
            <nav>
                <a href="index.html" class="nav-link">
                    ‚Üê Back to Dashboard
                </a>
            </nav>
        </header>

        <main>
            <!-- Current Portfolio Summary -->
            <div class="card fade-in">
                <div class="card-title">üìä Current Allocation</div>
                <div id="currentAllocation" class="current-allocation">
                    <div class="loading">Loading portfolio</div>
                </div>
                <div style="text-align: center; color: var(--text-muted); font-size: 0.9rem;" id="totalValue">
                    Total Portfolio: $0
                </div>
            </div>

            <!-- Target Allocation Input -->
            <div class="card fade-in" style="margin-top: var(--spacing-lg);">
                <div class="card-title">üéØ Target Allocation</div>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md); font-size: 0.9rem;">
                    Set category targets (must add to 100%). Expand each category to select assets and set their
                    intra-category allocation.
                </p>

                <!-- Category Sections with Assets -->
                <div id="categorySelections"></div>

                <div class="target-total" id="targetTotal">Total: 100%</div>

                <button class="btn btn-primary btn-block" id="calculateBtn">
                    üßÆ Calculate Rebalance
                </button>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <div class="card fade-in">
                    <div class="card-title">üìã Rebalance Actions</div>
                    <div id="resultsContent"></div>
                </div>

                <!-- Summary Box -->
                <div class="summary-box" id="summaryBox">
                    <div class="summary-title">üìä Summary</div>
                    <div class="summary-grid" id="summaryGrid"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="js/app.js"></script>
    <script>
        // Rebalance Calculator Logic
        let portfolioData = null;
        let assetSelections = {}; // { assetId: { selected: bool, targetPercent: number } }

        async function initRebalance() {
            await loadPortfolio();
            renderCategorySections();
            setupEventListeners();
            validateAll();
        }

        async function loadPortfolio() {
            try {
                portfolioData = await PortfolioApp.calculatePortfolio();
                renderCurrentAllocation();
                initializeAssetSelections();
            } catch (error) {
                console.error('Error loading portfolio:', error);
                document.getElementById('currentAllocation').innerHTML = `
                    <div class="no-assets-message">
                        Error loading portfolio. <a href="index.html">Go to dashboard</a>
                    </div>
                `;
            }
        }

        function initializeAssetSelections() {
            if (!portfolioData || !portfolioData.assets) return;

            // Group assets by category to calculate default percentages
            const categoryAssets = { crypto: [], stocks: [], gold: [] };
            portfolioData.assets.forEach(asset => {
                if (categoryAssets[asset.category]) {
                    categoryAssets[asset.category].push(asset);
                }
            });

            // Initialize each asset with equal distribution within category
            portfolioData.assets.forEach(asset => {
                const assetsInCategory = categoryAssets[asset.category]?.length || 1;
                const equalPercent = Math.round(100 / assetsInCategory);
                assetSelections[asset.id] = {
                    selected: true,
                    targetPercent: equalPercent
                };
            });

            // Adjust to ensure exactly 100% per category
            ['crypto', 'stocks', 'gold'].forEach(category => {
                adjustCategoryTotal(category);
            });
        }

        function adjustCategoryTotal(category) {
            if (!portfolioData) return;

            const categoryAssets = portfolioData.assets.filter(a => a.category === category);
            const selectedAssets = categoryAssets.filter(a => assetSelections[a.id]?.selected);

            if (selectedAssets.length === 0) return;

            // Calculate current total
            const currentTotal = selectedAssets.reduce((sum, a) => sum + (assetSelections[a.id]?.targetPercent || 0), 0);

            // If not 100%, adjust the last selected asset
            if (currentTotal !== 100 && selectedAssets.length > 0) {
                const lastAsset = selectedAssets[selectedAssets.length - 1];
                assetSelections[lastAsset.id].targetPercent += (100 - currentTotal);
            }
        }

        function renderCurrentAllocation() {
            const container = document.getElementById('currentAllocation');
            const totalEl = document.getElementById('totalValue');

            if (!portfolioData || portfolioData.grandTotal === 0) {
                container.innerHTML = `
                    <div class="no-assets-message" style="grid-column: 1 / -1;">
                        <p>üì≠ No assets in your portfolio</p>
                        <p><a href="admin.html">Add assets first</a> to use the rebalance calculator</p>
                    </div>
                `;
                totalEl.textContent = 'Total Portfolio: $0';
                return;
            }

            const { categories, grandTotal } = portfolioData;

            container.innerHTML = `
                <div class="allocation-card crypto">
                    <div class="allocation-label">Crypto</div>
                    <div class="allocation-value crypto">${PortfolioApp.formatCurrency(categories.crypto.total)}</div>
                    <div class="allocation-percent">${categories.crypto.percentage.toFixed(1)}%</div>
                </div>
                <div class="allocation-card stocks">
                    <div class="allocation-label">Stocks</div>
                    <div class="allocation-value stocks">${PortfolioApp.formatCurrency(categories.stocks.total)}</div>
                    <div class="allocation-percent">${categories.stocks.percentage.toFixed(1)}%</div>
                </div>
                <div class="allocation-card gold">
                    <div class="allocation-label">Gold</div>
                    <div class="allocation-value gold">${PortfolioApp.formatCurrency(categories.gold.total)}</div>
                    <div class="allocation-percent">${categories.gold.percentage.toFixed(1)}%</div>
                </div>
            `;

            totalEl.textContent = `Total Portfolio: ${PortfolioApp.formatCurrency(grandTotal)}`;
        }

        function renderCategorySections() {
            const container = document.getElementById('categorySelections');
            if (!portfolioData || !portfolioData.assets) {
                container.innerHTML = '';
                return;
            }

            const categoryConfig = {
                crypto: { emoji: 'ü™ô', name: 'Crypto', defaultTarget: 50 },
                stocks: { emoji: 'üìà', name: 'Stocks', defaultTarget: 30 },
                gold: { emoji: 'ü•á', name: 'Gold', defaultTarget: 20 }
            };

            let html = '';

            ['crypto', 'stocks', 'gold'].forEach(category => {
                const config = categoryConfig[category];
                const categoryAssets = portfolioData.assets.filter(a => a.category === category);
                const selectedCount = categoryAssets.filter(a => assetSelections[a.id]?.selected).length;
                const totalCount = categoryAssets.length;

                html += `
                    <div class="category-section ${category}" id="section-${category}">
                        <div class="category-header" onclick="toggleCategory('${category}')">
                            <div class="category-header-left">
                                <div class="category-header-info">
                                    <div class="category-header-title">
                                        <span>${config.emoji}</span>
                                        <span>${config.name}</span>
                                    </div>
                                    <div class="category-header-subtitle">
                                        ${selectedCount}/${totalCount} assets selected
                                    </div>
                                </div>
                            </div>
                            <div class="category-header-right">
                                <input type="number" class="category-target-input" id="target-${category}" 
                                    value="${config.defaultTarget}" min="0" max="100" step="1" 
                                    onclick="event.stopPropagation()">
                                <span style="color: var(--text-muted);">%</span>
                                <span class="expand-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="asset-list">
                `;

                if (categoryAssets.length === 0) {
                    html += `
                        <div class="asset-item">
                            <em style="color: var(--text-muted);">No assets in this category</em>
                        </div>
                    `;
                } else {
                    categoryAssets.forEach(asset => {
                        const selection = assetSelections[asset.id] || { selected: true, targetPercent: 0 };

                        // Icon
                        let iconHtml;
                        if (asset.iconUrl) {
                            iconHtml = `<img src="${asset.iconUrl}" alt="${asset.symbol}" onerror="this.style.display='none';this.parentElement.textContent='${asset.symbol ? asset.symbol.substring(0, 2) : '??'}';">`;
                        } else {
                            iconHtml = asset.symbol ? asset.symbol.substring(0, 2) : '??';
                        }

                        html += `
                            <div class="asset-item" id="asset-item-${asset.id}">
                                <div class="asset-item-left">
                                    <input type="checkbox" class="asset-checkbox" id="check-${asset.id}" 
                                        ${selection.selected ? 'checked' : ''} 
                                        onchange="toggleAsset('${asset.id}', '${category}')">
                                    <div class="asset-icon ${category}">${iconHtml}</div>
                                    <div class="asset-info">
                                        <div class="asset-name">${asset.name}</div>
                                        <div class="asset-value">${PortfolioApp.formatCurrency(asset.value)}</div>
                                    </div>
                                </div>
                                <div class="asset-target-group">
                                    <input type="number" class="asset-target-input" id="target-asset-${asset.id}" 
                                        value="${selection.targetPercent}" min="0" max="100" step="1"
                                        ${!selection.selected ? 'disabled' : ''}
                                        onchange="updateAssetTarget('${asset.id}', '${category}')">
                                    <span class="asset-target-label">%</span>
                                </div>
                            </div>
                        `;
                    });
                }

                // Intra-category total
                const intraCategoryTotal = categoryAssets.reduce((sum, a) => {
                    if (assetSelections[a.id]?.selected) {
                        return sum + (assetSelections[a.id]?.targetPercent || 0);
                    }
                    return sum;
                }, 0);

                html += `
                        <div class="intra-category-total ${intraCategoryTotal === 100 ? 'valid' : 'invalid'}" id="intra-total-${category}">
                            Asset allocation: ${intraCategoryTotal}% ${intraCategoryTotal === 100 ? '‚úì' : '(must be 100%)'}
                        </div>
                    </div>
                </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleCategory(category) {
            const section = document.getElementById(`section-${category}`);
            section.classList.toggle('expanded');
        }

        function toggleAsset(assetId, category) {
            const checkbox = document.getElementById(`check-${assetId}`);
            const targetInput = document.getElementById(`target-asset-${assetId}`);

            assetSelections[assetId].selected = checkbox.checked;
            targetInput.disabled = !checkbox.checked;

            if (!checkbox.checked) {
                assetSelections[assetId].targetPercent = 0;
                targetInput.value = 0;
            } else {
                // Redistribute percentages among selected assets
                redistributePercentages(category);
            }

            updateIntraCategoryTotal(category);
            updateCategorySubtitle(category);
            validateAll();
        }

        function updateAssetTarget(assetId, category) {
            const input = document.getElementById(`target-asset-${assetId}`);
            const value = parseFloat(input.value) || 0;
            assetSelections[assetId].targetPercent = Math.min(100, Math.max(0, value));
            input.value = assetSelections[assetId].targetPercent;

            updateIntraCategoryTotal(category);
            validateAll();
        }

        function redistributePercentages(category) {
            const categoryAssets = portfolioData.assets.filter(a => a.category === category);
            const selectedAssets = categoryAssets.filter(a => assetSelections[a.id]?.selected);

            if (selectedAssets.length === 0) return;

            const equalPercent = Math.floor(100 / selectedAssets.length);
            const remainder = 100 - (equalPercent * selectedAssets.length);

            selectedAssets.forEach((asset, index) => {
                const extra = index < remainder ? 1 : 0;
                assetSelections[asset.id].targetPercent = equalPercent + extra;
                const input = document.getElementById(`target-asset-${asset.id}`);
                if (input) input.value = assetSelections[asset.id].targetPercent;
            });
        }

        function updateIntraCategoryTotal(category) {
            const categoryAssets = portfolioData.assets.filter(a => a.category === category);
            const total = categoryAssets.reduce((sum, a) => {
                if (assetSelections[a.id]?.selected) {
                    return sum + (assetSelections[a.id]?.targetPercent || 0);
                }
                return sum;
            }, 0);

            const totalEl = document.getElementById(`intra-total-${category}`);
            if (totalEl) {
                totalEl.textContent = `Asset allocation: ${total}% ${total === 100 ? '‚úì' : '(must be 100%)'}`;
                totalEl.className = `intra-category-total ${total === 100 ? 'valid' : 'invalid'}`;
            }
        }

        function updateCategorySubtitle(category) {
            const categoryAssets = portfolioData.assets.filter(a => a.category === category);
            const selectedCount = categoryAssets.filter(a => assetSelections[a.id]?.selected).length;
            const totalCount = categoryAssets.length;

            const section = document.getElementById(`section-${category}`);
            const subtitle = section?.querySelector('.category-header-subtitle');
            if (subtitle) {
                subtitle.textContent = `${selectedCount}/${totalCount} assets selected`;
            }
        }

        function setupEventListeners() {
            // Category target inputs
            ['crypto', 'stocks', 'gold'].forEach(category => {
                const input = document.getElementById(`target-${category}`);
                if (input) {
                    input.addEventListener('input', validateAll);
                }
            });

            // Calculate button
            document.getElementById('calculateBtn').addEventListener('click', calculateRebalance);
        }

        function validateAll() {
            const crypto = parseFloat(document.getElementById('target-crypto')?.value) || 0;
            const stocks = parseFloat(document.getElementById('target-stocks')?.value) || 0;
            const gold = parseFloat(document.getElementById('target-gold')?.value) || 0;

            const categoryTotal = crypto + stocks + gold;
            const totalEl = document.getElementById('targetTotal');
            const calcBtn = document.getElementById('calculateBtn');

            totalEl.textContent = `Total: ${categoryTotal}%`;

            // Check category totals
            const categoryValid = categoryTotal === 100;

            // Check intra-category totals
            let intraValid = true;
            ['crypto', 'stocks', 'gold'].forEach(category => {
                const categoryAssets = portfolioData?.assets?.filter(a => a.category === category) || [];
                const selectedAssets = categoryAssets.filter(a => assetSelections[a.id]?.selected);

                if (selectedAssets.length > 0) {
                    const intraTotal = selectedAssets.reduce((sum, a) => sum + (assetSelections[a.id]?.targetPercent || 0), 0);
                    if (intraTotal !== 100) {
                        intraValid = false;
                    }
                }
            });

            const allValid = categoryValid && intraValid;

            if (allValid) {
                totalEl.className = 'target-total valid';
                calcBtn.disabled = false;
            } else {
                totalEl.className = 'target-total invalid';
                calcBtn.disabled = true;
            }

            return allValid;
        }

        function calculateRebalance() {
            if (!validateAll() || !portfolioData || portfolioData.grandTotal === 0) {
                return;
            }

            const targetCrypto = parseFloat(document.getElementById('target-crypto').value) / 100;
            const targetStocks = parseFloat(document.getElementById('target-stocks').value) / 100;
            const targetGold = parseFloat(document.getElementById('target-gold').value) / 100;

            const { categories, grandTotal, assets } = portfolioData;

            // Calculate target values for each category
            const targets = {
                crypto: grandTotal * targetCrypto,
                stocks: grandTotal * targetStocks,
                gold: grandTotal * targetGold
            };

            // Calculate difference (positive = need to buy, negative = need to sell)
            const diffs = {
                crypto: targets.crypto - categories.crypto.total,
                stocks: targets.stocks - categories.stocks.total,
                gold: targets.gold - categories.gold.total
            };

            // Calculate per-asset recommendations using intra-category targets
            const assetRecommendations = calculateAssetRecommendations(assets, targets, diffs);

            // Render results
            renderResults(diffs, assetRecommendations, targets);
        }

        function calculateAssetRecommendations(assets, targets, diffs) {
            const recommendations = [];

            ['crypto', 'stocks', 'gold'].forEach(category => {
                const categoryAssets = assets.filter(a => a.category === category);
                const categoryTarget = targets[category];

                categoryAssets.forEach(asset => {
                    const selection = assetSelections[asset.id];
                    const isSelected = selection?.selected;
                    const targetPercent = (selection?.targetPercent || 0) / 100;

                    if (!isSelected) {
                        // Asset not selected - recommend selling all
                        const usdChange = -asset.value;
                        const amountChange = -asset.balance;
                        recommendations.push({
                            ...asset,
                            usdChange,
                            amountChange,
                            action: asset.value > 1 ? 'sell' : 'hold',
                            excluded: true
                        });
                    } else {
                        // Calculate target value for this asset based on intra-category percentage
                        const assetTargetValue = categoryTarget * targetPercent;
                        const usdChange = assetTargetValue - asset.value;
                        const amountChange = asset.currentPrice > 0 ? usdChange / asset.currentPrice : 0;

                        recommendations.push({
                            ...asset,
                            usdChange,
                            amountChange,
                            targetValue: assetTargetValue,
                            targetPercent: targetPercent * 100,
                            action: usdChange > 1 ? 'buy' : usdChange < -1 ? 'sell' : 'hold'
                        });
                    }
                });
            });

            return recommendations;
        }

        function renderResults(diffs, assetRecommendations, targets) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');

            const categoryLabels = {
                crypto: { emoji: 'ü™ô', name: 'Crypto' },
                stocks: { emoji: 'üìà', name: 'Stocks' },
                gold: { emoji: 'ü•á', name: 'Gold' }
            };

            let html = '';

            ['crypto', 'stocks', 'gold'].forEach(category => {
                const catAssets = assetRecommendations.filter(a => a.category === category);
                const catDiff = diffs[category];
                const { emoji, name } = categoryLabels[category];

                const action = catDiff > 1 ? 'buy' : catDiff < -1 ? 'sell' : 'hold';
                const actionText = catDiff > 1
                    ? `Buy ${PortfolioApp.formatCurrency(Math.abs(catDiff))}`
                    : catDiff < -1
                        ? `Sell ${PortfolioApp.formatCurrency(Math.abs(catDiff))}`
                        : 'No change needed';

                html += `
                    <div class="result-category">
                        <div class="result-category-header">
                            <div class="result-category-title">
                                <span>${emoji}</span>
                                <span>${name}</span>
                            </div>
                            <div class="result-category-action ${action}">${actionText}</div>
                        </div>
                `;

                if (catAssets.length === 0) {
                    html += `<div class="asset-result"><em style="color: var(--text-muted);">No assets in this category</em></div>`;
                } else {
                    catAssets.forEach(asset => {
                        const actionClass = asset.action;
                        const actionLabel = asset.action === 'buy'
                            ? `Buy ${PortfolioApp.formatCurrency(Math.abs(asset.usdChange))}`
                            : asset.action === 'sell'
                                ? `Sell ${PortfolioApp.formatCurrency(Math.abs(asset.usdChange))}`
                                : 'Hold';

                        const amountText = Math.abs(asset.amountChange) > 0.000001
                            ? `${asset.action === 'buy' ? '+' : ''}${asset.amountChange.toFixed(6)} ${asset.symbol || 'units'}`
                            : '';

                        // Target info
                        const targetInfo = asset.targetPercent !== undefined
                            ? `Target: ${asset.targetPercent.toFixed(0)}% ‚Üí ${PortfolioApp.formatCurrency(asset.targetValue)}`
                            : asset.excluded ? 'Not included' : '';

                        // Icon
                        let iconHtml;
                        if (asset.iconUrl) {
                            iconHtml = `<img src="${asset.iconUrl}" alt="${asset.symbol}" onerror="this.style.display='none';this.parentElement.textContent='${asset.symbol ? asset.symbol.substring(0, 2) : '??'}';">`;
                        } else {
                            iconHtml = asset.symbol ? asset.symbol.substring(0, 2) : '??';
                        }

                        html += `
                            <div class="asset-result ${asset.excluded ? 'excluded' : ''}">
                                <div class="asset-result-info">
                                    <div class="asset-result-icon ${category}">${iconHtml}</div>
                                    <div>
                                        <div class="asset-result-name">${asset.name} ${asset.excluded ? '<span style="color: var(--text-muted);">(excluded)</span>' : ''}</div>
                                        <div class="asset-result-details">
                                            Current: ${asset.balance} ${asset.symbol || ''} (${PortfolioApp.formatCurrency(asset.value)})
                                            ${targetInfo ? `<br>${targetInfo}` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="asset-result-action">
                                    <div class="action-badge ${actionClass}">${actionLabel}</div>
                                    ${amountText ? `<div class="action-amount">${amountText}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }

                html += '</div>';
            });

            resultsContent.innerHTML = html;

            // Render summary
            const totalToBuy = assetRecommendations.filter(a => a.usdChange > 0).reduce((sum, a) => sum + a.usdChange, 0);
            const totalToSell = Math.abs(assetRecommendations.filter(a => a.usdChange < 0).reduce((sum, a) => sum + a.usdChange, 0));

            document.getElementById('summaryGrid').innerHTML = `
                <div class="summary-item">
                    <div class="summary-item-label">Total to Buy</div>
                    <div class="summary-item-value positive">${PortfolioApp.formatCurrency(totalToBuy)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-label">Total to Sell</div>
                    <div class="summary-item-value negative">${PortfolioApp.formatCurrency(totalToSell)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-label">Target Crypto</div>
                    <div class="summary-item-value">${PortfolioApp.formatCurrency(targets.crypto)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-label">Target Stocks</div>
                    <div class="summary-item-value">${PortfolioApp.formatCurrency(targets.stocks)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-label">Target Gold</div>
                    <div class="summary-item-value">${PortfolioApp.formatCurrency(targets.gold)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-label">Portfolio Total</div>
                    <div class="summary-item-value">${PortfolioApp.formatCurrency(portfolioData.grandTotal)}</div>
                </div>
            `;

            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initRebalance);
    </script>
</body>

</html>