<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Manage your portfolio assets">
    <title>Portfolio Tracker | Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="images/icon-192.png">
    <link rel="apple-touch-icon" href="images/icon-192.png">
    <meta name="theme-color" content="#0f172a">
    <style>
        /* Auth Modal Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .auth-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            max-width: 400px;
            width: 90%;
        }

        .auth-modal h2 {
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .auth-modal .form-hint {
            margin-bottom: var(--spacing-md);
        }

        .sync-bar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            align-items: center;
            flex-wrap: wrap;
        }

        .sync-status {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .sync-status.success {
            color: var(--accent-stocks);
        }

        .sync-status.error {
            color: #ff5050;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid var(--accent-stocks);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            color: var(--accent-stocks);
        }
    </style>
</head>

<body>
    <!-- Auth Modal -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2>üîê Admin Login</h2>
            <p class="form-hint">
                Enter your GitHub Personal Access Token to sync data across devices.
                Token is only stored in memory and cleared when you close the tab.
            </p>
            <form id="authForm">
                <div class="form-group">
                    <label class="form-label" for="authToken">GitHub Token</label>
                    <input type="password" class="form-input" id="authToken" placeholder="ghp_xxxxxxxxxxxx" required>
                    <div class="form-hint">
                        <a href="https://github.com/settings/tokens/new?scopes=gist&description=Portfolio%20Tracker"
                            target="_blank" style="color: var(--accent-crypto);">
                            Create a token with 'gist' scope ‚Üí
                        </a>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    üîì Login
                </button>
                <div id="authError" style="color: #ff5050; margin-top: 1rem; display: none;"></div>
            </form>
            <div style="margin-top: var(--spacing-md); text-align: center;">
                <button class="btn btn-secondary" id="skipAuthBtn">
                    Skip (Local Only)
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üìä</div>
                Portfolio Tracker
            </div>
            <nav>
                <a href="index.html" class="nav-link">
                    ‚Üê Back to Dashboard
                </a>
            </nav>
        </header>

        <!-- Sync Bar -->
        <div class="sync-bar" id="syncBar" style="display: none;">
            <div class="user-badge" id="userBadge">
                üë§ <span id="username">-</span>
            </div>
            <div class="sync-status" id="syncStatus">Ready to sync</div>
            <button class="btn btn-secondary" id="syncDownBtn" title="Download from cloud">
                ‚¨áÔ∏è Download
            </button>
            <button class="btn btn-primary" id="syncUpBtn" title="Upload to cloud">
                ‚¨ÜÔ∏è Upload
            </button>
            <button class="btn btn-secondary" id="logoutBtn" title="Logout">
                üö™
            </button>
        </div>

        <!-- Admin Content -->
        <main>
            <div class="admin-grid">
                <!-- Left Column: Input Forms -->
                <div style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
                    <!-- CoinStats API Configuration -->
                    <div class="card fade-in" id="apiKeyCard">
                        <div class="card-title">üîë CoinStats API Key (Optional)</div>
                        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md); font-size: 0.9rem;">
                            CoinStats API is free for basic use. Add a key to increase rate limits.
                        </p>

                        <div class="form-group">
                            <label class="form-label" for="coinstatsApiKey">API Key</label>
                            <input type="password" class="form-input" id="coinstatsApiKey"
                                placeholder="Enter your CoinStats API key">
                            <div class="form-hint">
                                <a href="https://coinstats.app/api-pricing" target="_blank"
                                    style="color: var(--accent-crypto);">
                                    Get API key ‚Üí
                                </a>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="saveKeyBtn">
                                üíæ Save API Key
                            </button>
                            <button class="btn btn-secondary" id="testKeyBtn">
                                üß™ Test Connection
                            </button>
                            <button type="button" class="btn btn-secondary" id="showKeyBtn">
                                üëÅÔ∏è Show Key
                            </button>
                            <button class="btn btn-danger" id="clearKeyBtn">
                                üóëÔ∏è Clear Key
                            </button>
                        </div>

                        <div id="apiKeyStatus" style="margin-top: 12px; display: none;"></div>
                    </div>

                    <!-- Add Asset Form -->
                    <div class="card fade-in">
                        <div class="card-title" id="formTitle">Add New Asset</div>

                        <form id="assetForm">
                            <input type="hidden" id="editingId" value="">

                            <!-- Category Selector -->
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <div class="category-selector">
                                    <button type="button" class="category-btn crypto active" data-category="crypto">
                                        ü™ô Crypto
                                    </button>
                                    <button type="button" class="category-btn stocks" data-category="stocks">
                                        üìà Stocks
                                    </button>
                                    <button type="button" class="category-btn gold" data-category="gold">
                                        ü•á Gold
                                    </button>
                                </div>
                            </div>

                            <!-- Asset Name -->
                            <div class="form-group">
                                <label class="form-label" for="assetName">Asset Name</label>
                                <input type="text" class="form-input" id="assetName"
                                    placeholder="e.g., Bitcoin, Tesla Stock, PAX Gold" required>
                            </div>

                            <!-- Symbol -->
                            <div class="form-group">
                                <label class="form-label" for="assetSymbol">
                                    Symbol
                                    <span style="color: var(--text-muted); font-weight: normal;">(required)</span>
                                </label>
                                <input type="text" class="form-input" id="assetSymbol"
                                    placeholder="e.g., BTC, ETH, AAPL, PAXG" required>
                            </div>

                            <!-- CoinStats ID -->
                            <div class="form-group">
                                <label class="form-label" for="coinstatsId">
                                    CoinStats Coin ID
                                    <span style="color: var(--text-muted); font-weight: normal;">(optional)</span>
                                </label>
                                <input type="text" class="form-input" id="coinstatsId"
                                    placeholder="e.g., bitcoin, ethereum">
                                <div class="form-hint">
                                    Override symbol lookup. Find IDs in CoinStats URL (e.g.,
                                    coinstats.app/coins/<strong>bitcoin</strong>).
                                </div>
                            </div>

                            <!-- Manual Price (alternative to API) -->
                            <div class="form-group">
                                <label class="form-label" for="manualPrice">
                                    Manual Price (USD)
                                    <span style="color: var(--text-muted); font-weight: normal;">(overrides API)</span>
                                </label>
                                <input type="number" class="form-input" id="manualPrice"
                                    placeholder="Leave empty to use CoinStats" step="any" min="0">
                            </div>

                            <!-- Buy/Average Price for ROI -->
                            <div class="form-group">
                                <label class="form-label" for="buyPrice">
                                    Buy/Avg Price (USD)
                                    <span style="color: var(--text-muted); font-weight: normal;">(for ROI
                                        tracking)</span>
                                </label>
                                <input type="number" class="form-input" id="buyPrice"
                                    placeholder="Your average purchase price" step="any" min="0">
                            </div>

                            <!-- ‚ú® NEW: Purchase Date Field -->
                            <div class="form-group">
                                <label class="form-label" for="purchaseDate">
                                    Purchase Date
                                    <span style="color: var(--text-muted); font-weight: normal;">(for performance
                                        tracking)</span>
                                </label>
                                <input type="date" class="form-input" id="purchaseDate" max="9999-12-31">
                                <div class="form-hint">
                                    When did you buy this asset? Used to calculate accurate historical performance.
                                </div>
                            </div>

                            <!-- Balance -->
                            <div class="form-group">
                                <label class="form-label" for="assetBalance">Balance (Amount Held)</label>
                                <input type="number" class="form-input" id="assetBalance"
                                    placeholder="e.g., 0.5, 10, 100" step="any" min="0" required>
                            </div>

                            <!-- Icon URL (manual override) -->
                            <div class="form-group">
                                <label class="form-label" for="iconUrl">
                                    Icon URL
                                    <span style="color: var(--text-muted); font-weight: normal;">(optional, auto-fetched
                                        with CoinStats ID)</span>
                                </label>
                                <input type="url" class="form-input" id="iconUrl"
                                    placeholder="https://... (paste image URL)">
                            </div>

                            <!-- Notes -->
                            <div class="form-group">
                                <label class="form-label" for="assetNotes">
                                    Notes
                                    <span style="color: var(--text-muted); font-weight: normal;">(optional)</span>
                                </label>
                                <textarea class="form-input notes-field" id="assetNotes"
                                    placeholder="Add notes about this asset (strategy, target, reminders...)"></textarea>
                            </div>

                            <!-- Submit Buttons -->
                            <div style="display: flex; gap: 1rem;">
                                <button type="submit" class="btn btn-primary btn-block">
                                    üíæ Save Asset
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none;">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Bulk Update Purchase Dates (Compact) -->
                    <div class="card fade-in">
                        <div class="card-title" style="margin-bottom: 12px; font-size: 1rem;">üìÖ Bulk Update Dates</div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="date" class="form-input" id="bulkPurchaseDate" style="flex:1;">
                            <button class="btn btn-secondary" id="bulkUpdateBtn" style="white-space: nowrap;">
                                Apply to All
                            </button>
                        </div>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px; margin-bottom: 0;">
                            Set default date for all assets.
                        </p>
                    </div>
                </div>

                <!-- Right Column: Lists -->
                <div style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
                    <!-- Assets List -->
                    <div class="card fade-in">
                        <div class="card-title"
                            style="display: flex; justify-content: space-between; align-items: center;">
                            Your Assets
                            <div style="display: flex; gap: 8px;">
                                <button class="export-btn" id="exportCsvBtn" title="Export to CSV">
                                    üì• Export CSV
                                </button>
                            </div>
                        </div>

                        <div id="adminAssetsList">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <p>No assets added yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Cache Management -->
                    <div class="card fade-in">
                        <div class="card-title">üóÑÔ∏è Cache Management</div>
                        <div id="cacheStats"
                            style="margin-bottom: 12px; font-size: 0.9rem; color: var(--text-secondary);">
                            Click 'Check Stats' to view cache usage.
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="showCacheStats()">
                                Check Stats
                            </button>
                            <button class="btn btn-danger" onclick="clearHistoricalCache()">
                                Clear Cache
                            </button>
                        </div>
                    </div>



                </div>
            </div>

            <!-- Popular CoinStats IDs Reference -->
            <div class="card fade-in" style="margin-top: var(--spacing-lg);">
                <div class="card-title">Popular Symbols & IDs</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <strong style="color: var(--accent-crypto);">Major Coins:</strong>
                        <ul
                            style="list-style: none; color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                            <li>Bitcoin ‚Üí BTC (ID: <code style="color: var(--text-primary);">bitcoin</code>)</li>
                            <li>Ethereum ‚Üí ETH (ID: <code style="color: var(--text-primary);">ethereum</code>)</li>
                            <li>BNB ‚Üí BNB (ID: <code style="color: var(--text-primary);">binance-coin</code>)</li>
                            <li>Solana ‚Üí SOL (ID: <code style="color: var(--text-primary);">solana</code>)</li>
                        </ul>
                    </div>
                    <div>
                        <strong style="color: var(--accent-crypto);">Altcoins:</strong>
                        <ul
                            style="list-style: none; color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                            <li>NEAR ‚Üí NEAR (ID: <code style="color: var(--text-primary);">near-protocol</code>)</li>
                            <li>Chainlink ‚Üí LINK (ID: <code style="color: var(--text-primary);">chainlink</code>)</li>
                            <li>Aave ‚Üí AAVE (ID: <code style="color: var(--text-primary);">aave</code>)</li>
                            <li>Uniswap ‚Üí UNI (ID: <code style="color: var(--text-primary);">uniswap</code>)</li>
                        </ul>
                    </div>
                </div>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted);">
                    üí° <strong>Pro Tip:</strong> Just use <strong>Symbol</strong> (BTC, ETH) - finding the ID is rarely
                    needed!
                </p>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="js/app.js"></script>
    <script src="js/dom-utils.js"></script>

    <script>
        // Admin Page Logic - Enhanced
        let selectedCategory = 'crypto';
        let editingId = null;
        let currentUser = null;

        function initAdmin() {
            // Initialize theme
            ThemeManager.init();

            setupAuth();
            setupCategorySelector();
            setupForm();
            setupApiKeyManagement(); // ‚ú® NEW
            setupSync();
            setupExport();
            renderAssetsList();
            setupBulkUpdate();
        }

        // ============ CoinStats API Key Management ============
        function setupApiKeyManagement() {
            const apiKeyInput = document.getElementById('coinstatsApiKey');
            const saveBtn = document.getElementById('saveKeyBtn');
            const testBtn = document.getElementById('testKeyBtn');
            const showBtn = document.getElementById('showKeyBtn');
            const clearBtn = document.getElementById('clearKeyBtn');
            const statusDiv = document.getElementById('apiKeyStatus');

            // Load existing key
            const existingKey = CoinStatsAPIKeyManager.get();
            if (existingKey) {
                apiKeyInput.value = existingKey;
            }

            // Save API key
            saveBtn.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();

                if (!apiKey) {
                    ToastManager.warning('Please enter an API key');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<div class="loading"><span class="loading-dots">Validating</span></div>';

                const validation = await CoinStatsAPIKeyManager.validate(apiKey);

                if (validation.valid) {
                    CoinStatsAPIKeyManager.set(apiKey);

                    statusDiv.innerHTML = `
                        <div style="padding: 12px; background: var(--profit-bg); 
                            border: 1px solid var(--profit-border); border-radius: 8px; color: var(--profit-text);">
                            ‚úì API key saved! BTC Price: $${validation.testPrice.toLocaleString()}
                        </div>
                    `;

                    ToastManager.success('API key saved!');

                    // Auto-sync to Gist
                    if (PortfolioApp.isAuthenticated()) {
                        try {
                            await PortfolioApp.syncToGist();
                            ToastManager.success('Synced to cloud!');
                        } catch (error) {
                            console.warn('Sync failed:', error);
                        }
                    }
                } else {
                    statusDiv.innerHTML = `
                        <div style="padding: 12px; background: var(--loss-bg); 
                            border: 1px solid var(--loss-border); border-radius: 8px; color: var(--loss-text);">
                            ‚úó Invalid: ${validation.error}
                        </div>
                    `;

                    ToastManager.error('Invalid API key');
                }
            });

            // Test connection
            testBtn.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();

                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<div class="loading"><span class="loading-dots">Testing</span></div>';

                const validation = await CoinStatsAPIKeyManager.validate(apiKey);

                if (validation.valid) {
                    statusDiv.innerHTML = `
                        <div style="padding: 12px; background: var(--profit-bg); 
                            border: 1px solid var(--profit-border); border-radius: 8px; color: var(--profit-text);">
                            ‚úì Success! BTC: $${validation.testPrice.toLocaleString()}
                        </div>
                    `;
                    ToastManager.success('Connection successful!');
                } else {
                    statusDiv.innerHTML = `
                        <div style="padding: 12px; background: var(--loss-bg); 
                            border: 1px solid var(--loss-border); border-radius: 8px; color: var(--loss-text);">
                            ‚úó Failed: ${validation.error}
                        </div>
                    `;
                    ToastManager.error('Connection failed');
                }
            });

            // Show/hide key
            showBtn.addEventListener('click', () => {
                const isPassword = apiKeyInput.type === 'password';
                apiKeyInput.type = isPassword ? 'text' : 'password';
                showBtn.textContent = isPassword ? 'üôà Hide' : 'üëÅÔ∏è Show';
            });

            // Clear key
            clearBtn.addEventListener('click', () => {
                if (confirm('Clear API key?')) {
                    CoinStatsAPIKeyManager.clear();
                    apiKeyInput.value = '';
                    statusDiv.style.display = 'none';
                    ToastManager.info('Cleared');
                }
            });
        }

        // ============ Bulk Update ============
        function setupBulkUpdate() {
            document.getElementById('bulkUpdateBtn').addEventListener('click', () => {
                const date = document.getElementById('bulkPurchaseDate').value;
                if (!date) {
                    ToastManager.warning('Please select a date');
                    return;
                }

                if (!confirm(`Set purchase date to ${date} for ALL assets?`)) {
                    return;
                }

                const assets = PortfolioApp.getAssets();
                let updated = 0;

                assets.forEach(asset => {
                    if (!asset.purchaseDate) {
                        asset.purchaseDate = date;
                        updated++;
                    }
                });

                if (updated > 0) {
                    PortfolioApp.saveAssets(assets);
                    ToastManager.success(`Updated ${updated} assets`);
                    renderAssetsList();
                } else {
                    ToastManager.info('No assets needed updating');
                }
            });
        }

        function addPurchaseDateToExistingAssets() {
            const assets = PortfolioApp.getAssets();
            let updated = 0;

            assets.forEach(asset => {
                if (!asset.purchaseDate) {
                    // Default to 30 days ago if no purchase date
                    const defaultDate = new Date();
                    defaultDate.setDate(defaultDate.getDate() - 30);
                    asset.purchaseDate = defaultDate.toISOString().split('T')[0];
                    updated++;
                }
            });

            if (updated > 0) {
                PortfolioApp.saveAssets(assets);
                ToastManager.success(`Added default purchase dates to ${updated} assets`);
                console.log(`‚úì Migrated ${updated} assets with default purchase dates`);
            }
        }

        // ============ Authentication ============
        function setupAuth() {
            const authForm = document.getElementById('authForm');
            const skipBtn = document.getElementById('skipAuthBtn');

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = document.getElementById('authToken').value.trim();
                const errorDiv = document.getElementById('authError');

                errorDiv.style.display = 'none';

                const result = await PortfolioApp.validateToken(token);

                if (result.valid) {
                    PortfolioApp.setSessionToken(token);
                    currentUser = result.username;
                    hideAuthModal();
                    showSyncBar();
                    ToastManager.success(`Welcome, ${currentUser}!`);
                } else {
                    errorDiv.textContent = 'Invalid token. Please check and try again.';
                    errorDiv.style.display = 'block';
                }
            });

            skipBtn.addEventListener('click', () => {
                hideAuthModal();
                ToastManager.info('Working in local-only mode');
            });
        }

        function hideAuthModal() {
            document.getElementById('authOverlay').style.display = 'none';
        }

        function showSyncBar() {
            document.getElementById('syncBar').style.display = 'flex';
            document.getElementById('username').textContent = currentUser || 'Guest';
        }

        // ============ Sync Functions ============
        function setupSync() {
            document.getElementById('syncUpBtn').addEventListener('click', syncUp);
            document.getElementById('syncDownBtn').addEventListener('click', syncDown);
            document.getElementById('logoutBtn').addEventListener('click', logout);
        }

        async function syncUp() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = 'Pushing...';
            statusEl.className = 'sync-status';

            try {
                const result = await PortfolioApp.syncToGist();
                statusEl.textContent = '‚úì Pushed successfully!';
                statusEl.className = 'sync-status success';
                ToastManager.success('Data synced to cloud!');
            } catch (error) {
                statusEl.textContent = '‚úó Push failed: ' + error.message;
                statusEl.className = 'sync-status error';
                ToastManager.error('Sync failed: ' + error.message);
            }
        }

        async function syncDown() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = 'Pulling...';
            statusEl.className = 'sync-status';

            try {
                const result = await PortfolioApp.syncFromGist();
                if (result.success) {
                    statusEl.textContent = `‚úì Pulled ${result.count} assets!`;
                    statusEl.className = 'sync-status success';
                    renderAssetsList();
                    ToastManager.success(`Loaded ${result.count} assets from cloud!`);
                } else {
                    statusEl.textContent = result.message;
                    statusEl.className = 'sync-status error';
                }
            } catch (error) {
                statusEl.textContent = '‚úó Pull failed: ' + error.message;
                statusEl.className = 'sync-status error';
                ToastManager.error('Pull failed: ' + error.message);
            }
        }

        function logout() {
            PortfolioApp.logout();
            currentUser = null;
            document.getElementById('syncBar').style.display = 'none';
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('authToken').value = '';
            ToastManager.info('Logged out');
        }

        // ============ Category Selector ============
        function setupCategorySelector() {
            const buttons = document.querySelectorAll('.category-btn');

            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedCategory = btn.dataset.category;
                });
            });
        }

        // ============ Form Handling ============
        function setupForm() {
            const form = document.getElementById('assetForm');
            const cancelBtn = document.getElementById('cancelBtn');

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                saveAsset();
            });

            cancelBtn.addEventListener('click', () => {
                resetForm();
            });
        }

        function saveAsset() {
            const asset = {
                name: document.getElementById('assetName').value.trim(),
                symbol: document.getElementById('assetSymbol').value.trim().toUpperCase(),
                coinstatsId: document.getElementById('coinstatsId').value.trim() || null,
                manualPrice: document.getElementById('manualPrice').value || null,
                buyPrice: document.getElementById('buyPrice').value || null,
                purchaseDate: document.getElementById('purchaseDate').value || null,
                balance: document.getElementById('assetBalance').value,
                iconUrl: document.getElementById('iconUrl').value.trim() || null,
                notes: document.getElementById('assetNotes').value.trim() || null,
                category: selectedCategory
            };

            const isEdit = !!editingId;
            const oldAsset = isEdit ? PortfolioApp.getAssets().find(a => a.id === editingId) : null;

            if (editingId) {
                PortfolioApp.updateAsset(editingId, asset);
                ToastManager.success(`Updated ${asset.name}`);
            } else {
                PortfolioApp.addAsset(asset);
                ToastManager.success(`Added ${asset.name}`);
            }

            resetForm();
            renderAssetsList();
        }

        function editAsset(id) {
            const assets = PortfolioApp.getAssets();
            const asset = assets.find(a => a.id === id);

            if (!asset) return;

            editingId = id;

            // Fill form
            document.getElementById('assetName').value = asset.name;
            document.getElementById('assetSymbol').value = asset.symbol || '';
            document.getElementById('coinstatsId').value = asset.coinstatsId || '';
            document.getElementById('manualPrice').value = asset.manualPrice || '';
            document.getElementById('buyPrice').value = asset.buyPrice || '';
            document.getElementById('purchaseDate').value = asset.purchaseDate || '';
            document.getElementById('assetBalance').value = asset.balance;
            document.getElementById('iconUrl').value = asset.iconUrl || '';
            document.getElementById('assetNotes').value = asset.notes || '';

            // Select category
            selectedCategory = asset.category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === selectedCategory);
            });

            // Update UI
            document.getElementById('formTitle').textContent = 'Edit Asset';
            document.getElementById('cancelBtn').style.display = 'block';

            // Scroll to form
            document.getElementById('assetForm').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteAsset(id) {
            const asset = PortfolioApp.getAssets().find(a => a.id === id);
            if (!asset) return;

            if (confirm(`Are you sure you want to delete ${asset.name}?`)) {
                PortfolioApp.deleteAsset(id);
                renderAssetsList();
                ToastManager.info(`Deleted ${asset.name}`);

                if (editingId === id) {
                    resetForm();
                }
            }
        }

        function resetForm() {
            editingId = null;
            document.getElementById('assetForm').reset();
            document.getElementById('formTitle').textContent = 'Add New Asset';
            document.getElementById('cancelBtn').style.display = 'none';

            // Reset category to crypto
            selectedCategory = 'crypto';
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === 'crypto');
            });
        }

        // ============ Export Functions ============
        function setupExport() {
            document.getElementById('exportCsvBtn').addEventListener('click', exportAssetsCSV);
        }

        function exportAssetsCSV() {
            const assets = PortfolioApp.getAssets();
            if (assets.length === 0) {
                ToastManager.warning('No assets to export');
                return;
            }

            const headers = ['Name', 'Symbol', 'Category', 'Balance', 'Buy Price', 'Notes'];
            const rows = assets.map(a => [
                a.name,
                a.symbol || '',
                a.category,
                a.balance,
                a.buyPrice || '',
                (a.notes || '').replace(/,/g, ';')
            ]);

            downloadCSV([headers, ...rows], 'portfolio_assets.csv');
            ToastManager.success('Assets exported!');
        }

        function downloadCSV(rows, filename) {
            const csv = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============ Render Assets ============
        function renderAssetsList() {
            const container = document.getElementById('adminAssetsList');
            const assets = PortfolioApp.getAssets();

            if (assets.length === 0) {
                DOMUtils.showEmptyState(container, 'No assets added yet');
                return;
            }

            const grouped = {
                crypto: assets.filter(a => a.category === 'crypto'),
                stocks: assets.filter(a => a.category === 'stocks'),
                gold: assets.filter(a => a.category === 'gold')
            };

            const categoryLabels = {
                crypto: 'ü™ô Crypto',
                stocks: 'üìà USA Stocks',
                gold: 'ü•á Gold'
            };

            container.innerHTML = '';

            Object.entries(grouped).forEach(([cat, catAssets]) => {
                if (catAssets.length === 0) return;

                const header = DOMUtils.createElement('h4', {
                    text: categoryLabels[cat],
                    styles: {
                        color: `var(--accent-${cat})`,
                        margin: '1rem 0 0.5rem'
                    }
                });
                container.appendChild(header);

                catAssets.forEach(asset => {
                    const item = DOMUtils.createAdminAssetItem(asset, {
                        onEdit: editAsset,
                        onDelete: deleteAsset
                    });
                    container.appendChild(item);
                });
            });
        }

        // ============ Cache Management ============
        function showCacheStats() {
            if (typeof HistoricalPriceAPI === 'undefined') {
                ToastManager.error('Historical API not loaded');
                return;
            }
            const stats = HistoricalPriceAPI.getCacheStats();
            const container = document.getElementById('cacheStats');
            if (container) {
                container.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>Entries:</span>
                        <strong style="color: var(--text-primary);">${stats.entries}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Size:</span>
                        <strong style="color: var(--text-primary);">${stats.sizeKB} KB</strong>
                    </div>
                `;
            }
            ToastManager.info(`Cache has ${stats.entries} entries`);
        }

        function clearHistoricalCache() {
            if (confirm('Clear all historical price cache? (This will trigger new API calls next time)')) {
                // Clear all possible cache versions
                localStorage.removeItem('portfolio_historical_cache_v3');
                localStorage.removeItem('portfolio_historical_cache_v4');

                // Also clear the cache via the API if available
                if (typeof HistoricalPriceAPI !== 'undefined' && HistoricalPriceAPI.clearCache) {
                    HistoricalPriceAPI.clearCache();
                }

                showCacheStats();
                ToastManager.success('Cache cleared!');
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initAdmin);
    </script>
</body>

</html>